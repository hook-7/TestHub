# 🤖 自动化命令工具模块使用指南

## 📖 概述

本模块为工厂生产测试上位机提供了完整的自动化命令执行功能，支持：
- ✅ 预定义命令模板
- ⚠️ 用户确认机制  
- 📊 实时状态监控
- 📝 完整操作日志

---

## 🚀 快速开始

### 1. 访问自动化控制页面
```
http://192.168.100.3:3000/automation
```

### 2. 在通信页面使用工具栏
通信页面已集成自动化工具栏，提供快速操作按钮。

---

## 🔧 功能模块

### 📋 预定义命令模板

| 模板名称 | 类型 | 需要确认 | 说明 |
|---------|------|---------|------|
| 清理缓存 | 系统 | ❌ | 清理系统临时文件和缓存 |
| 备份数据 | 维护 | ✅ | 备份系统重要数据 |
| 重启设备 | 设备 | ✅ | 重启指定测试设备 |
| 执行测试序列 | 测试 | ✅ | 运行自动化测试流程 |

### 🎯 使用场景

#### 场景1: 快速系统维护
```typescript
// 清理缓存 - 无需确认，立即执行
automationStore.executeTemplate('clear_cache', {})
```

#### 场景2: 设备操作 - 需要确认
```typescript
// 重启设备 - 需要用户确认
automationStore.executeTemplate('restart_device', {
  device_id: 'DEV001',
  force: false
})
// 系统会自动弹出确认对话框
```

#### 场景3: 测试流程
```typescript
// 执行测试序列 - 需要确认
automationStore.executeTemplate('run_test_sequence', {
  sequence_name: 'FULL_TEST',
  product_sn: 'SN20240101001'
})
```

---

## 🔒 安全机制

### ⚠️ 确认流程
1. **创建命令** → 状态: `pending`
2. **弹出确认对话框** → 显示命令详情和风险提示
3. **用户确认/取消** → 状态: `confirmed`/`cancelled`
4. **执行命令** → 状态: `executing` → `success`/`failed`

### 📝 操作日志
所有操作都会记录：
- 🕐 操作时间
- 👤 操作员ID
- 🏭 工位ID
- 📋 命令详情
- ✅ 执行结果

---

## 💻 开发集成

### 在页面中集成工具栏

```vue
<template>
  <div>
    <!-- 现有内容 -->
    
    <!-- 添加自动化工具栏 -->
    <AutomationToolbar
      :show-status="true"
      :quick-template-ids="['clear_cache', 'backup_data']"
      :workstation-id="currentWorkstation"
      :operator-id="currentOperator"
      @command-created="handleAutomationCommand"
      @show-history="showAutomationHistory"
    />
  </div>
</template>

<script setup>
import AutomationToolbar from '@/components/AutomationToolbar.vue'

const handleAutomationCommand = (command) => {
  console.log('命令已创建:', command)
}

const showAutomationHistory = () => {
  // 跳转到自动化历史页面
}
</script>
```

### 使用Store管理状态

```typescript
import { useAutomationStore } from '@/stores/automation'

const automationStore = useAutomationStore()

// 加载模板
await automationStore.loadTemplates()

// 执行命令
const command = await automationStore.executeTemplate('backup_data', {
  backup_path: '/tmp/backup'
})

// 监控状态
console.log('等待确认:', automationStore.pendingCommands)
console.log('正在执行:', automationStore.executingCommands)
```

---

## 🔗 API接口

### 后端API (FastAPI)

**基础路径**: `/api/v1/automation`

#### 命令管理
- `POST /commands` - 创建命令
- `GET /commands` - 获取命令列表  
- `GET /commands/{id}` - 获取单个命令
- `POST /commands/{id}/confirm` - 确认命令
- `DELETE /commands/{id}` - 取消命令

#### 模板管理
- `GET /templates` - 获取模板列表
- `POST /templates/{id}/execute` - 执行模板

### 前端API

```typescript
import AutomationAPI from '@/api/automation'

// 执行模板命令
const result = await AutomationAPI.executeTemplateCommand(
  'restart_device',
  { device_id: 'DEV001' },
  'OP001',
  'WS001'
)
```

---

## 📊 状态监控

### 命令状态
- 🟡 `pending` - 等待确认
- 🔵 `confirmed` - 已确认
- ⚡ `executing` - 执行中  
- ✅ `success` - 执行成功
- ❌ `failed` - 执行失败
- 🚫 `cancelled` - 已取消

### 实时监控
- 工具栏显示等待确认和执行中的命令数量
- 自动轮询更新命令状态
- 执行完成后显示结果通知

---

## 🛠️ 扩展开发

### 添加新命令模板

1. **后端**: 在 `AutomationService._init_default_templates()` 中添加
2. **前端**: 模板会自动加载，无需修改代码

```python
CommandTemplate(
    template_id="custom_command",
    name="自定义命令",
    command_type=CommandType.SYSTEM,
    description="这是一个自定义命令",
    parameters_schema={
        "param1": {"type": "string", "required": True, "description": "参数1"}
    },
    requires_confirmation=True
)
```

### 实现命令执行逻辑

在 `AutomationService._execute_command_sync()` 中添加具体的命令执行代码。

---

## 🎯 最佳实践

1. **危险操作必须确认**: 设备控制、数据删除等操作
2. **记录详细日志**: 包含操作员、时间、参数等信息  
3. **设置合理超时**: 避免命令长时间占用资源
4. **错误处理**: 提供清晰的错误信息和恢复建议
5. **权限控制**: 确保只有授权用户可以执行特定命令

---

## 📞 支持

如有问题，请查看：
- API文档: http://192.168.100.3:8000/api/v1/docs
- 系统日志: 后端会记录详细的操作日志
- 前端控制台: 包含详细的调试信息