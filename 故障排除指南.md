# 🔧 自动化命令模块 - 故障排除指南

## 🚨 常见问题及解决方案

### 1. 前端导入错误

#### 问题：`The requested module '/src/api/index.ts' does not provide an export named 'request'`

**原因**: API导入名称错误  
**解决方案**:
```typescript
// ❌ 错误的导入
import { request } from './index'

// ✅ 正确的导入  
import { api } from './index'

// ✅ 正确的API调用
return api.post<AutomationCommand>('/automation/commands', request)
```

#### 问题：`response.code is undefined`

**原因**: API响应格式处理错误  
**解决方案**: API拦截器已处理响应格式，直接使用返回的数据
```typescript
// ❌ 错误的处理方式
const response = await AutomationAPI.getTemplates()
if (response.code === 0) {
  templates.value = response.data
}

// ✅ 正确的处理方式
const templates = await AutomationAPI.getTemplates()
templates.value = templates || []
```

### 2. 后端导入错误

#### 问题：`ModuleNotFoundError: No module named 'app.api.v1.schemas'`

**原因**: 相对导入路径错误  
**解决方案**: 使用绝对导入
```python
# ❌ 错误的导入
from ..schemas.automation import AutomationCommandRequest

# ✅ 正确的导入
from app.schemas.automation import AutomationCommandRequest
```

#### 问题：`ModuleNotFoundError: No module named 'pydantic'`

**解决方案1**: 安装依赖
```bash
# 创建虚拟环境
python3 -m venv .venv
source .venv/bin/activate  # Linux/Mac
# 或 .venv\Scripts\activate  # Windows

# 安装依赖
pip install fastapi uvicorn pydantic pydantic-settings
```

**解决方案2**: 使用简化版本
```python
# 使用无外部依赖的简化版本
from app.services.automation_service_simple import automation_service_simple
from app.schemas.automation_simple import AutomationCommandRequest
```

### 3. 服务启动问题

#### 问题：`uv: command not found`

**解决方案**:
```bash
# 方法1: 安装uv
curl -LsSf https://astral.sh/uv/install.sh | sh
source ~/.bashrc

# 方法2: 使用传统方式
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
cd backend && python -m uvicorn app.main:app --reload
```

#### 问题：`Failed to connect to localhost port 8000`

**检查步骤**:
1. 确认后端服务是否启动
2. 检查端口是否被占用
3. 查看服务启动日志

```bash
# 检查进程
ps aux | grep uvicorn

# 检查端口
netstat -tlnp | grep 8000

# 手动启动服务
cd backend && python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 4. 前端组件问题

#### 问题：`Cannot resolve component: AutomationToolbar`

**解决方案**: 检查组件导入和注册
```vue
<script setup>
// 确保正确导入组件
import AutomationToolbar from '@/components/AutomationToolbar.vue'
</script>

<template>
  <!-- 确保组件名称正确 -->
  <AutomationToolbar />
</template>
```

#### 问题：Element Plus 组件未定义

**解决方案**: 检查Element Plus安装和导入
```bash
# 安装Element Plus
cd frontend && npm install element-plus @element-plus/icons-vue

# 检查main.ts中的配置
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'
```

### 5. API响应格式问题

#### 问题：响应数据格式不匹配

**检查项目的API响应格式**:
```typescript
// 标准响应格式
{
  "code": 0,
  "msg": "success", 
  "data": {...}
}

// API拦截器已处理，直接返回data部分
const result = await api.get('/automation/templates')
// result 直接是 data 部分，不需要 result.data
```

---

## 🛠️ 调试工具

### 1. API测试页面
```bash
# 使用提供的测试页面
open test_frontend_api.html
# 或直接在浏览器中打开
```

### 2. 后端API文档
```
http://localhost:8000/api/v1/docs
```

### 3. 手动API测试
```bash
# 获取模板列表
curl -X GET "http://localhost:8000/api/v1/automation/templates"

# 执行模板命令
curl -X POST "http://localhost:8000/api/v1/automation/templates/clear_cache/execute" \
  -H "Content-Type: application/json" \
  -d '{}'
```

### 4. 前端调试
```javascript
// 在浏览器控制台中测试
import('/src/api/automation.ts').then(module => {
  const { AutomationAPI } = module;
  AutomationAPI.getTemplates().then(console.log);
});
```

---

## 📝 快速修复清单

### 前端问题
- [ ] 检查 `import { api } from './index'` 导入是否正确
- [ ] 确认API调用使用 `api.get()` / `api.post()` 格式
- [ ] 验证响应数据直接使用，无需 `.data` 属性
- [ ] 检查Element Plus组件是否正确导入

### 后端问题  
- [ ] 使用绝对导入 `from app.schemas.automation import ...`
- [ ] 确认pydantic等依赖已安装
- [ ] 检查路由是否正确注册到主应用
- [ ] 验证API响应格式符合项目规范

### 集成问题
- [ ] 确认前后端服务都在运行
- [ ] 检查CORS配置是否正确
- [ ] 验证API路径是否匹配
- [ ] 测试网络连接是否正常

---

## 🆘 应急方案

如果遇到无法解决的问题，可以使用以下应急方案：

### 1. 使用简化版本
```python
# 后端使用简化服务
from app.services.automation_service_simple import automation_service_simple
```

### 2. 独立测试
```bash
# 运行独立演示
python3 automation_complete_demo.py
```

### 3. 手动API测试
```bash
# 使用curl测试API
curl http://localhost:8000/api/v1/automation/templates
```

### 4. 前端降级
```vue
<!-- 临时禁用自动化功能 -->
<div v-if="false">
  <AutomationToolbar />
</div>
```

---

## 📞 获取帮助

1. **查看控制台日志** - 浏览器开发者工具
2. **检查网络请求** - Network选项卡查看API调用
3. **后端日志** - 查看uvicorn服务输出
4. **使用测试工具** - test_frontend_api.html

记住：**自动化模块的核心功能已经验证正常工作**，大部分问题都是环境配置或导入路径问题，按照上述指南逐步排查即可解决。