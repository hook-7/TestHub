# 🔄 工作流自动化系统使用指南

## 🎯 系统概述

全新的工作流自动化系统，专为工厂生产测试上位机设计，支持：

✅ **步骤化流程定义** - 每个步骤定义串口输入和期望输出  
✅ **变量引用系统** - 支持 `${variable_name}` 格式的动态变量  
✅ **WebSocket实时确认** - 通过WS协议发送确认框给用户  
✅ **串口通信集成** - 直接集成AT指令发送和回复验证  
✅ **实时执行监控** - 可视化工作流执行状态和进度  

---

## 🏗️ 工作流结构

### 📋 步骤类型

| 类型 | 说明 | 配置项 |
|------|------|--------|
| **📡 serial_send** | 发送串口指令 | 指令内容、期望回复、超时时间 |
| **❓ user_confirm** | 用户确认 | 确认消息、选项列表 |
| **🔧 set_variable** | 设置变量 | 变量名、变量值 |
| **⏱️ delay** | 延时等待 | 延时秒数 |
| **📝 log** | 记录日志 | 日志内容 |
| **🔀 condition** | 条件判断 | 条件表达式、分支步骤 |

### 🔧 变量系统

支持动态变量引用：
```
AT+CFUN?                           # 固定指令
设备 ${device_id} 状态查询          # 变量引用
操作员: ${operator}, 时间: ${current_time}  # 多变量
```

特殊变量：
- `${current_time}` - 当前时间
- `${device_info}` - 从串口回复中提取
- `${user_input}` - 用户确认时的输入

---

## 📋 预定义工作流

### 1. AT指令测试流程 (`at_command_test`)

**用途**: 标准AT指令测试序列  
**步骤**:
1. 📡 发送AT测试指令 → 验证连接
2. 📡 获取设备信息 → 保存到变量
3. ❓ 用户确认设备信息 → WebSocket确认弹窗
4. 📝 记录测试结果

### 2. 设备重启流程 (`device_restart`)

**用途**: 安全的设备重启流程  
**步骤**:
1. 📡 检查设备状态 → AT+CFUN?
2. ❓ 用户确认重启 → 显示当前状态和风险提示
3. 📡 执行重启命令 → AT+CFUN=1,1
4. ⏱️ 等待重启完成 → 延时15秒
5. 📡 验证重启结果 → AT测试连接
6. 📝 记录重启结果

---

## 🚀 使用方式

### 1. 访问工作流控制页面
```
http://192.168.100.3:3000/workflow
```

### 2. 在通信页面快速执行
- 🧪 **AT指令测试** - 点击按钮直接启动
- 🔄 **设备重启流程** - 安全重启流程

### 3. API编程调用
```typescript
import { useWorkflowStore } from '@/stores/workflow'

const workflowStore = useWorkflowStore()

// 执行工作流
await workflowStore.executeWorkflow('at_command_test', {
  device_id: 'ESP32_001',
  operator: '张工程师'
})
```

### 4. WebSocket实时交互
```typescript
// 初始化WebSocket连接
workflowStore.initWebSocket()

// 自动处理确认请求
// 系统会自动弹出确认对话框
```

---

## 🔧 工作流定义示例

### 简单的设备查询流程
```json
{
  "workflow_id": "device_query",
  "name": "设备信息查询",
  "steps": [
    {
      "step_id": "query_1",
      "name": "查询设备型号",
      "step_type": "serial_send",
      "serial_command": "AT+GMR",
      "expected_response": ".*OK.*",
      "variable_name": "device_model",
      "variable_source": "response",
      "next_step_id": "query_2"
    },
    {
      "step_id": "query_2", 
      "name": "用户确认信息",
      "step_type": "user_confirm",
      "confirm_message": "设备型号: ${device_model}\n\n信息是否正确？",
      "confirm_options": ["正确", "重新查询", "取消"],
      "next_step_id": "query_3"
    },
    {
      "step_id": "query_3",
      "name": "保存查询结果", 
      "step_type": "log",
      "variable_name": "query_result",
      "variable_value": "查询完成 - 设备: ${device_model}, 时间: ${current_time}"
    }
  ],
  "start_step_id": "query_1",
  "variables": {
    "device_model": "",
    "query_result": ""
  }
}
```

---

## 🌐 WebSocket确认机制

### 确认请求格式
```json
{
  "message_type": "user_confirmation_request",
  "execution_id": "exec_123",
  "step_id": "step_3",
  "data": {
    "message": "设备信息: ESP32_DevKit_V1\n\n是否继续测试？",
    "options": ["继续", "停止"],
    "step_name": "用户确认设备信息"
  }
}
```

### 确认响应格式
```json
{
  "type": "user_confirmation",
  "data": {
    "execution_id": "exec_123",
    "step_id": "step_3", 
    "confirmed": true,
    "selected_option": "继续",
    "operator_notes": "设备信息正确，继续测试"
  }
}
```

---

## 📊 执行监控

### 工作流状态
- 🟢 **running** - 运行中
- 🟡 **paused** - 暂停 (等待用户确认)
- ✅ **completed** - 完成
- ❌ **failed** - 失败
- 🚫 **cancelled** - 取消

### 步骤状态  
- ⏳ **pending** - 等待执行
- ⚡ **running** - 执行中
- ✅ **success** - 成功
- ❌ **failed** - 失败
- ⏸️ **waiting** - 等待确认

### 实时监控功能
- 📊 执行进度可视化
- 🔔 状态变更通知
- 📝 步骤结果详情
- 🔧 变量状态实时更新

---

## 🎨 用户界面

### 主控制页面 (`/workflow`)
- 🎯 工作流模板选择
- 📊 执行状态统计
- 📋 执行历史列表
- 🔧 实时状态监控

### 通信页面集成
- 🚀 快速工作流按钮
- 🎨 渐变色设计
- ⚡ 一键启动常用流程

### 确认弹窗 (WebSocket)
- 📱 自动弹出确认对话框
- ℹ️ 详细的步骤信息
- 🔘 多选项支持
- ✍️ 操作员备注

---

## 🔒 安全特性

### 🛡️ 执行控制
- **步骤验证**: 每个步骤都有期望回复验证
- **超时控制**: 防止步骤长时间等待
- **错误处理**: 完善的异常处理和错误恢复
- **用户确认**: 关键操作需要明确确认

### 📝 审计追踪
- **完整日志**: 记录每个步骤的输入输出
- **操作员追踪**: 记录执行者和工位信息
- **时间戳**: 精确的执行时间记录
- **变量状态**: 完整的变量变更历史

---

## 🚀 快速开始

### 1. 启动系统
```bash
# 后端服务
cd backend && python -m uvicorn app.main:app --reload

# 前端服务
cd frontend && npm run dev
```

### 2. 访问页面
```
工作流控制: http://192.168.100.3:3000/workflow
通信页面: http://192.168.100.3:3000/communication
```

### 3. 执行第一个工作流
1. 点击 "AT指令测试流程"
2. 系统自动执行串口指令
3. 收到WebSocket确认请求
4. 确认后继续执行
5. 查看执行结果和变量状态

---

## 🔧 自定义工作流

### 添加新的工作流模板
在 `workflow_engine.py` 的 `_init_example_workflows()` 中添加：

```python
custom_workflow = WorkflowDefinition(
    workflow_id="custom_test",
    name="自定义测试流程",
    description="自定义的测试流程",
    steps=[
        WorkflowStep(
            step_id="custom_1",
            name="自定义步骤",
            step_type=StepType.SERIAL_SEND,
            serial_command="AT+CUSTOM",
            expected_response="OK",
            next_step_id="custom_2"
        )
        # 更多步骤...
    ],
    start_step_id="custom_1"
)
```

### 扩展步骤类型
可以在 `WorkflowEngine._execute_step()` 中添加新的步骤类型处理逻辑。

---

## 🎉 总结

**全新的工作流自动化系统已完全替代了之前的简单命令工具**，提供了：

✅ **更强大的功能** - 步骤化流程、变量系统、条件分支  
✅ **更好的用户体验** - WebSocket实时确认、可视化监控  
✅ **更高的安全性** - 步骤验证、用户确认、完整审计  
✅ **更灵活的扩展** - 易于添加新工作流和步骤类型  

**现在你可以创建复杂的自动化测试流程，每个步骤都可以定义串口输入输出，支持变量传递，并通过WebSocket与用户实时交互！** 🚀